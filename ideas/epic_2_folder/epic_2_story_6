Story 6 – JournalEntry Data Model Updates

Goal

Update the JournalEntry data model and useJournalStore to properly handle the new tagging fields (emotionIds, peopleTagIds, contextTagIds). This story ensures that journal entries can be created and updated with emotion and tag associations, preparing the data layer for UI integration in subsequent stories. The database migration for these fields has already been completed in Story 5, so this story focuses on updating the TypeScript interfaces and store logic.

⸻

Scope

1.	JournalEntry Interface Verification
	•	Verify that the JournalEntry interface in src/domain/journal.ts includes the tagging fields:
	•	emotionIds: string[] (Array of Emotion IDs)
	•	peopleTagIds: string[] (Array of PeopleTag IDs)
	•	contextTagIds: string[] (Array of ContextTag IDs)
	•	Note: These fields may be optional (emotionIds?: string[]) in the interface, but the database migration (Story 5) ensures all existing entries have these fields as empty arrays. The interface should reflect that these fields are always present (either as required fields or optional fields that default to empty arrays).
	•	If the fields are currently optional, consider whether they should be required (since migration ensures they exist). However, optional fields with default empty arrays are acceptable and maintain backward compatibility.
	•	The interface should match the epic specification:
	•	interface JournalEntry {
	•	  id: string;
	•	  createdAt: string;
	•	  updatedAt: string;
	•	  title?: string;
	•	  body: string;
	•	  emotionIds: string[];        // Array of Emotion IDs
	•	  peopleTagIds: string[];      // Array of PeopleTag IDs
	•	  contextTagIds: string[];      // Array of ContextTag IDs
	•	}
	•	Note: The epic shows these fields as required (no `?`), but if they're currently optional in the codebase, that's acceptable as long as the migration ensures they're always present.

2.	JournalRepository Interface Verification
	•	Verify that the JournalRepository interface in src/repositories/journalRepository.ts properly handles the new fields:
	•	The create() method signature uses Omit<JournalEntry, 'id' | 'createdAt' | 'updatedAt'>, which automatically includes the new tagging fields
	•	The update() method accepts JournalEntry, which includes all fields
	•	No changes to method signatures are needed, but verify that the interface correctly reflects that these fields are part of JournalEntry
	•	The repository implementation (journalDexieRepository.ts) should already handle these fields correctly since it spreads the data object, but verify this is working as expected

3.	useJournalStore.createEntry() Update
	•	Update the createEntry action in src/stores/journal.store.ts:
	•	Current signature: createEntry(payload: { title?: string; body: string })
	•	New signature: createEntry(payload: { title?: string; body: string; emotionIds?: string[]; peopleTagIds?: string[]; contextTagIds?: string[] })
	•	The new fields should be optional in the payload (to maintain backward compatibility and allow creating entries without tags)
	•	When creating an entry:
	•	If emotionIds is not provided, default to empty array []
	•	If peopleTagIds is not provided, default to empty array []
	•	If contextTagIds is not provided, default to empty array []
	•	Pass all fields (including defaults) to the repository.create() method
	•	The repository will handle generating id, createdAt, and updatedAt
	•	Example implementation:
	•	async function createEntry(payload: {
	•	  title?: string
	•	  body: string
	•	  emotionIds?: string[]
	•	  peopleTagIds?: string[]
	•	  contextTagIds?: string[]
	•	}) {
	•	  const entryData = {
	•	    ...payload,
	•	    emotionIds: payload.emotionIds ?? [],
	•	    peopleTagIds: payload.peopleTagIds ?? [],
	•	    contextTagIds: payload.contextTagIds ?? [],
	•	  }
	•	  const newEntry = await journalDexieRepository.create(entryData)
	•	  entries.value.push(newEntry)
	•	  return newEntry
	•	}

4.	useJournalStore.updateEntry() Verification
	•	Verify that the updateEntry action in src/stores/journal.store.ts properly handles the new fields:
	•	Current signature: updateEntry(entry: JournalEntry)
	•	Since updateEntry accepts the full JournalEntry object, it already includes the new tagging fields
	•	No changes needed to the method signature
	•	Verify that when an entry is updated with new tag IDs, they are properly persisted
	•	The repository.update() method should already handle this correctly since it accepts the full JournalEntry

5.	Repository Implementation Verification
	•	Verify that journalDexieRepository.create() properly handles the new fields:
	•	The create() method spreads ...data, which should include emotionIds, peopleTagIds, and contextTagIds
	•	Verify that these fields are persisted to IndexedDB correctly
	•	Verify that journalDexieRepository.update() properly handles the new fields:
	•	The update() method accepts the full JournalEntry and uses db.journalEntries.put(), which should persist all fields
	•	Verify that journalDexieRepository.getAll() and getById() return entries with the new fields
	•	Since the migration (Story 5) ensures all existing entries have these fields, all entries should have them when loaded

6.	Backward Compatibility
	•	Ensure backward compatibility:
	•	Existing code that calls createEntry() without the new fields should continue to work
	•	Entries created without tags should have empty arrays for emotionIds, peopleTagIds, and contextTagIds
	•	Entries loaded from the database should always have these fields (migration ensures this)
	•	No breaking changes to existing API contracts

7.	Minimal Tests (Unit)
	•	Update unit tests in src/stores/__tests__/journal.store.spec.ts:
	•	Test createEntry with tagging fields:
	•	Creating an entry with emotionIds, peopleTagIds, and contextTagIds persists them correctly
	•	Creating an entry without tagging fields defaults them to empty arrays
	•	Creating an entry with partial tagging fields (e.g., only emotionIds) defaults missing fields to empty arrays
	•	Test updateEntry with tagging fields:
	•	Updating an entry with new tag IDs updates them correctly
	•	Updating an entry to remove tags (empty arrays) persists correctly
	•	Test loadEntries with tagging fields:
	•	Loading entries from the database includes the tagging fields
	•	Entries loaded from the database have empty arrays if no tags were set
	•	Test that tag IDs are preserved through create/update/load cycle:
	•	Create entry with tags → Load entry → Verify tags are present
	•	Update entry with new tags → Load entry → Verify new tags are present
	•	Use mocked repository implementations for tests (no need to hit real IndexedDB in unit tests)
	•	Mock the repository to return entries with the new fields

⸻

Acceptance Criteria

	•	JournalEntry interface includes emotionIds, peopleTagIds, and contextTagIds fields (as required or optional with defaults)
	•	JournalRepository interface correctly reflects that these fields are part of JournalEntry (via Omit<JournalEntry, ...>)
	•	useJournalStore.createEntry() accepts optional emotionIds, peopleTagIds, and contextTagIds in the payload
	•	createEntry() defaults missing tagging fields to empty arrays []
	•	createEntry() persists all tagging fields to the repository correctly
	•	useJournalStore.updateEntry() properly handles tagging fields (already works since it accepts full JournalEntry)
	•	journalDexieRepository.create() persists tagging fields to IndexedDB correctly
	•	journalDexieRepository.update() persists tagging fields to IndexedDB correctly
	•	journalDexieRepository.getAll() and getById() return entries with tagging fields
	•	Backward compatibility is maintained:
	•	Existing code calling createEntry() without tags continues to work
	•	Entries created without tags have empty arrays for tagging fields
	•	All unit tests pass:
	•	createEntry with tags works correctly
	•	createEntry without tags defaults to empty arrays
	•	updateEntry with tags works correctly
	•	loadEntries includes tagging fields
	•	Tag IDs are preserved through create/update/load cycle
	•	No linting errors or TypeScript errors
	•	The data layer is ready for UI integration in Story 7 (Journal Editor Integration)

⸻

Out of Scope

	•	UI components for tag selection (this is Story 7: Journal Editor Integration)
	•	Displaying tags in JournalView (this is Story 8: Journal View Display Updates)
	•	Database migration (this is Story 5: Database Migration Strategy, already complete)
	•	EmotionLog feature (this is Stories 9-11)
	•	E2E tests (comprehensive testing comes in Story 12)
	•	Tag validation (e.g., checking if tag IDs exist in the database) – this can be added later if needed
	•	Tag management UI (this will come in a later epic)

⸻

Inconsistencies & Notes

	1.	JournalEntry Interface Field Requirements:
	•	The epic specification shows emotionIds, peopleTagIds, and contextTagIds as required fields (no `?`):
	•	interface JournalEntry {
	•	  emotionIds: string[];        // Array of Emotion IDs
	•	  peopleTagIds: string[];      // Array of PeopleTag IDs
	•	  contextTagIds: string[];     // Array of ContextTag IDs
	•	}
	•	However, the current implementation may have them as optional (emotionIds?: string[])
	•	Resolution: Optional fields are acceptable as long as:
	•	The database migration (Story 5) ensures all existing entries have these fields
	•	The store defaults them to empty arrays when creating entries
	•	All code that reads entries handles the case where fields might be undefined (or they're always defined due to migration)
	•	If the fields are optional in the interface, consider adding a comment explaining that they're always present in persisted entries (due to migration) but optional in the create payload for convenience
	•	Alternatively, make them required in the interface to match the epic specification exactly

	2.	Database Migration Dependency:
	•	Story 5 (Database Migration Strategy) has already been completed
	•	The migration ensures all existing journal entries have emotionIds, peopleTagIds, and contextTagIds fields (as empty arrays if they didn't exist before)
	•	Story 6 depends on Story 5 being complete, which it is
	•	No inconsistencies here – the database schema is ready for Story 6

	3.	Repository Interface vs. Implementation:
	•	The JournalRepository interface uses Omit<JournalEntry, 'id' | 'createdAt' | 'updatedAt'> for the create() method
	•	This means if JournalEntry includes the new fields, they're automatically part of the create() payload type
	•	The repository implementation (journalDexieRepository.create()) spreads ...data, which should include all fields
	•	No changes needed to the repository interface or implementation, but verification is important
	•	The repository should already be handling these fields correctly

	4.	Store Method Signatures:
	•	The epic mentions "No changes needed to method signatures, but payload types should include optional emotionIds, peopleTagIds, contextTagIds"
	•	This means:
	•	createEntry() signature should be updated to include the new optional fields
	•	updateEntry() signature doesn't need changes (it already accepts full JournalEntry)
	•	The story should update createEntry() to accept these fields while maintaining backward compatibility

	5.	Default Values Strategy:
	•	When creating an entry without tags, the store should default emotionIds, peopleTagIds, and contextTagIds to empty arrays
	•	This ensures consistency: all entries have these fields, even if they're empty
	•	The defaulting can happen in the store (before calling repository.create()) or in the repository itself
	•	Recommendation: Default in the store (createEntry method) so the repository receives complete data
	•	This makes the data flow clearer and ensures the repository always receives these fields

	6.	Type Safety:
	•	TypeScript should ensure type safety throughout:
	•	createEntry() payload type should include the new optional fields
	•	The repository.create() method should accept these fields (via Omit<JournalEntry, ...>)
	•	The repository should return JournalEntry with all fields
	•	No type assertions or `any` types should be needed
	•	If type errors occur, they should be resolved by properly typing the interfaces and methods

	7.	Testing Strategy:
	•	Unit tests should verify:
	•	createEntry() with tags persists them correctly
	•	createEntry() without tags defaults to empty arrays
	•	updateEntry() with tags updates them correctly
	•	loadEntries() returns entries with tagging fields
	•	Tests should use mocked repositories to avoid IndexedDB dependencies
	•	Integration tests (testing with real IndexedDB) can be added in Story 12 (Comprehensive Testing)

	8.	Story Dependencies:
	•	Story 6 depends on:
	•	Story 2 (People & Context Tag Domain Models) – tag tables exist in database ✓
	•	Story 5 (Database Migration Strategy) – journal entry migration is complete ✓
	•	Story 1 (Emotions Database & Domain Model) – emotions exist in store ✓
	•	All dependencies are satisfied, so Story 6 can proceed

	9.	Consistency Check with Story 5:
	•	Story 5 (just implemented) created the EmotionLog interface and added the emotionLogs table
	•	Story 5 also migrated existing journal entries to include emotionIds, peopleTagIds, and contextTagIds
	•	Story 6 updates the store to handle these fields when creating/updating entries
	•	No conflicts: Story 5 prepared the database, Story 6 prepares the code to use it
	•	The migration ensures all existing entries have the fields, so Story 6's code can assume they exist

	10.	Consistency Check with Recent Changes:
	•	Verification that Story 6 aligns with current codebase state:
	•	JournalEntry interface already has emotionIds, peopleTagIds, contextTagIds (as optional) ✓
	•	Database migration (Story 5) ensures all entries have these fields ✓
	•	Repository interface uses Omit<JournalEntry, ...> which includes new fields ✓
	•	Repository implementation spreads ...data which includes new fields ✓
	•	Store's createEntry() needs to be updated to accept new fields ← This is Story 6's main task
	•	Store's updateEntry() already works (accepts full JournalEntry) ✓
	•	No inconsistencies detected that would require backtracking from Story 5 or earlier stories

	11.	Future Integration:
	•	Story 7 (Journal Editor Integration) will use the updated createEntry() and updateEntry() methods
	•	Story 7 will pass emotionIds, peopleTagIds, and contextTagIds from the UI components (EmotionSelector, TagInput) to the store
	•	Story 6 prepares the data layer so Story 7 can focus on UI integration
	•	The separation is clean: Story 6 = data layer, Story 7 = UI layer

	12.	Optional vs. Required Fields in Interface:
	•	Decision point: Should emotionIds, peopleTagIds, and contextTagIds be required or optional in JournalEntry?
	•	Epic shows them as required (no `?`)
	•	Current implementation may have them as optional
	•	Recommendation: If they're currently optional, consider making them required to match the epic specification, since:
	•	The migration ensures all entries have these fields
	•	The store will default them to empty arrays
	•	Required fields make the type system more accurate
	•	However, if optional fields are working well and maintain backward compatibility, that's also acceptable
	•	The story should verify the current state and document the decision

